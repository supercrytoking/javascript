!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b(require("crypto"),require("buffer")):"function"==typeof define&&define.amd?define(["crypto","buffer"],b):"object"==typeof exports?exports.PUBNUB=b(require("crypto"),require("buffer")):a.PUBNUB=b(a.crypto,a.buffer)}(this,function(a,b){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){function d(a,b){return h.createHmac("sha256",new i(b,"utf8")).update(a).digest("base64")}function e(a){console.error(a)}function f(a){function b(a,b){g({message:a,payload:b})}var c,d,e,f=a.success||function(){},g=a.fail||function(){},h=a.mode||"GET",i=a.data||{},j={};i.pnsdk=l,"POST"===h&&(c=decodeURIComponent(a.url.pop())),e=k.build_url(a.url,i),e="/"+e.split("/").slice(3).join("/"),d=a.url[0].split("//")[1],j.url="http://"+d+e,j.method=h,j.body=c,Parse.Cloud.httpRequest(j).then(function(a){var c;try{c=JSON.parse(a.text)}catch(d){return void b("Bad JSON response",a.text)}f(c)},function(a){var c;try{c=JSON.parse(a.text),"object"==typeof c&&"error"in c&&c.error===!0?g(c):b("Network error",a.text)}catch(d){b("Network error",a.text)}})}function g(){function a(a){return h.createHash("sha256").update(a).digest("hex").slice(0,32)}var b="0123456789012345";return{encrypt:function(c,d){if(!d)return c;var e=JSON.stringify(c),f=h.createCipheriv("aes-256-cbc",a(d),b),g=f.update(e,"utf8","base64")+f["final"]("base64");return g||c},decrypt:function(c,d){var e;if(!d)return c;var f=h.createDecipheriv("aes-256-cbc",a(d),b);try{e=f.update(c,"base64","utf8")+f["final"]("utf8")}catch(g){return null}return JSON.parse(e)}}}var h=c(1),i=c(2).Buffer,j=c(3),k=c(4),l="PubNub-JS-Parse/"+j.version,m=function(){var a={};return{get:function(b){return a[b]},set:function(b,c){a[b]=c}}}(),n=function(a){a.xdr=f,a.db=m,a.error=a.error||e,a.hmac_SHA256=d,a.crypto_obj=g(),a.params={pnsdk:l};var b=function(a){return n(a)},c=k.PN_API(a);for(var h in c)c.hasOwnProperty(h)&&(b[h]=c[h]);return b.init=b,b.secure=b,b.subscribe=function(){throw Error("#subscribe() method is disabled in Parse.com environment")},b.ready(),b};n.init=n,n.unique=k.unique,n.secure=n,a.exports=n,a.exports.PNmessage=k.PNmessage},function(b,c){b.exports=a},function(a,c){a.exports=b},function(a,b){a.exports={name:"pubnub",preferGlobal:!1,version:"3.10.0",author:"PubNub <support@pubnub.com>",description:"Publish & Subscribe Real-time Messaging with PubNub",contributors:[{name:"Stephen Blum",email:"stephen@pubnub.com"}],bin:{},scripts:{test:"grunt test --force"},main:"./node.js/pubnub.js",browser:"./modern/dist/pubnub.js",repository:{type:"git",url:"git://github.com/pubnub/javascript.git"},keywords:["cloud","publish","subscribe","websockets","comet","bosh","xmpp","real-time","messaging"],dependencies:{agentkeepalive:"~0.2",lodash:"^4.1.0"},noAnalyze:!1,devDependencies:{chai:"^3.5.0",eslint:"^1.10.3","eslint-config-airbnb":"^5.0.0","eslint-plugin-mocha":"^1.1.0","eslint-plugin-react":"^3.16.1",grunt:"^0.4.5","grunt-contrib-clean":"^0.6.0","grunt-contrib-uglify":"^0.11.1","grunt-env":"^0.4.4","grunt-eslint":"^17.3.1","grunt-karma":"^0.12.1","grunt-mocha-istanbul":"^3.0.1","grunt-text-replace":"^0.4.0","grunt-webpack":"^1.0.11","imports-loader":"^0.6.5",istanbul:"^0.4.2","json-loader":"^0.5.4",karma:"^0.13.21","karma-chai":"^0.1.0","karma-mocha":"^0.2.1","karma-phantomjs-launcher":"^1.0.0","karma-spec-reporter":"0.0.24","load-grunt-tasks":"^3.4.0",mocha:"^2.1.0",nock:"^1.1.0","node-uuid":"^1.4.7",nodeunit:"^0.9.0","phantomjs-prebuilt":"^2.1.4",sinon:"^1.17.2","uglify-js":"^2.6.1",underscore:"^1.7.0",webpack:"^1.12.13"},bundleDependencies:[],license:"MIT",engine:{node:">=0.8"},files:["core","node.js","modern","CHANGELOG","FUTURE.md","LICENSE","README.md"]}},function(a,b,c){function d(){return"x"+ ++y+ +new Date}function e(){return+new Date}function f(a,b){var c=a.join(H),d=[];return b?(o(b,function(a,b){var c="object"==typeof b?JSON.stringify(b):b;"undefined"!=typeof b&&null!=b&&r(c).length>0&&d.push(a+"="+r(c))}),c+="?"+d.join(I)):c}function g(a,b){var c,d=0,f=function(){d+b>e()?(clearTimeout(c),c=setTimeout(f,b)):(d=e(),a())};return f}function h(a,b){var c=[];return o(a||[],function(a){b(a)&&c.push(a)}),c}function i(a,b){return a.replace(M,function(a,c){return b[c]||a})}function j(a,b){return setTimeout(a,b)}function l(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)});return a&&a(b),b}function m(a){return!!a&&"string"!=typeof a&&(Array.isArray&&Array.isArray(a)||"number"==typeof a.length)}function o(a,b){if(a&&b)if(m(a))for(var c=0,d=a.length;d>c;)b.call(a[c],a[c],c++);else for(var c in a)a.hasOwnProperty&&a.hasOwnProperty(c)&&b.call(a[c],c,a[c])}function p(a,b){var c=[];return o(a||[],function(a,d){c.push(b(a,d))}),c}function q(a){return encodeURIComponent(a).replace(/[!'()*~]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})}function r(a){return encodeURIComponent(a)}function s(a,b){var c=[];return o(a,function(a,d){b?a.search("-pnpres")<0&&d.subscribed&&c.push(a):d.subscribed&&c.push(a)}),c.sort()}function t(a,b){var c=[];return o(a,function(a,d){b?a.search("-pnpres")<0&&d.subscribed&&c.push(a):d.subscribed&&c.push(a)}),c.sort()}function u(){z||(z=1,o(A,function(a){a()}))}function v(a){return msg=a||{apns:{}},msg.getPubnubMessage=function(){var a={};if(Object.keys(msg.apns).length){a.pn_apns={aps:{alert:msg.apns.alert,badge:msg.apns.badge}};for(var b in msg.apns)a.pn_apns[b]=msg.apns[b];var c=["badge","alert"];for(var b in c)delete a.pn_apns[c[b]]}msg.gcm&&(a.pn_gcm={data:msg.gcm});for(var b in msg)a[b]=msg[b];var d=["apns","gcm","publish","channel","callback","error"];for(var b in d)delete a[d[b]];return a},msg.publish=function(){var a=msg.getPubnubMessage();msg.pubnub&&msg.channel&&msg.pubnub.publish({message:a,channel:msg.channel,callback:msg.callback,error:msg.error})},msg}function w(a){function b(a){return a||(a={}),o(Ga,function(b,c){b in a||(a[b]=c)}),a}function c(a){var b=[];return o(a,function(a,c){b.push(a)}),b}function v(a){return c(a).sort()}function w(a){var b="",c=v(a);for(var d in c){var e=c[d];b+=e+"="+q(a[e]),d!=c.length-1&&(b+="&")}return b}function x(a,b,c){var d=!1;if("undefined"==typeof a)return b;if("number"==typeof a)d=a>J||0==a?!1:!0;else{if("boolean"==typeof a)return a?K:0;d=!0}return d?(c&&c("Presence Heartbeat value invalid. Valid range ( x > "+J+" or x = 0). Current Value : "+(b||J)),b||J):a}function y(a,b){return Sa.encrypt(a,b||La)||a}function D(a,b){return Sa.decrypt(a,b||La)||Sa.decrypt(a,La)||a}function H(){return clearTimeout(za),!Ba||Ba>=500||1>Ba||!s(wa,!0).length&&!t(xa,!0).length?void(Ca=!1):(Ca=!0,void Ta.presence_heartbeat({callback:function(a){za=j(H,Ba*G)},error:function(a){Ha&&Ha("Presence Heartbeat unable to reach Pubnub servers."+JSON.stringify(a)),za=j(H,Ba*G)}}))}function I(){!Ca&&H()}function M(a){if(Da){if(!na.length)return}else{if(a&&(na.sending=0),na.sending||!na.length)return;na.sending=1}Fa(na.shift())}function O(a){var b=0;return o(t(xa),function(c){var d=xa[c];d&&(b++,(a||function(){})(d))}),b}function P(a){var b=0;return o(s(wa),function(c){var d=wa[c];d&&(b++,(a||function(){})(d))}),b}function Q(a,b,c){if("object"==typeof a){if(a.error){var d={};return a.message&&(d.message=a.message),a.payload&&(d.payload=a.payload),void(c&&c(d))}if(a.payload)return void(a.next_page?b&&b(a.payload,a.next_page):b&&b(a.payload))}b&&b(a)}function R(a,b){if("object"==typeof a&&a.error){var c={};return a.message&&(c.message=a.message),a.payload&&(c.payload=a.payload),void(b&&b(c))}b&&b(a)}function S(a,c,d,e){var c=a.callback||c,f=a.error||Ha,g=Ja();e=e||{},e.auth||(e.auth=a.auth_key||fa);var h=[ka,"v1","channel-registration","sub-key",ea];h.push.apply(h,d),g&&(e.callback=g),Fa({callback:g,data:b(e),success:function(a){Q(a,c,f)},fail:function(a){R(a,f)},url:h})}function T(){Ia()||V(1,{error:"Offline. Please check your network settings. "}),Y&&clearTimeout(Y),Y=j(T,G)}function U(){ba&&Ta.time(function(a){X(function(){},a),a||V(1,{error:"Heartbeat failed to connect to Pubnub Servers.Please check your network settings."}),Z&&clearTimeout(Z),Z=j(U,aa)})}function V(a,b){sa&&sa(a,b),sa=null,clearTimeout(Y),clearTimeout(Z)}function W(a){var b=e()-pa;return b-a/1e4}function X(a,b){function c(b){if(b){var c=b/1e4,f=(e()-d)/2;pa=e()-(c+f),a&&a(pa)}}var d=e();b&&c(b)||Ta.time(c)}var Y,Z,$=+a.windowing||C,_=(+a.timeout||E)*G,aa=(+a.keepalive||F)*G,ba=a.timecheck||0,ca=a.noleave||0,da=a.publish_key,ea=a.subscribe_key,fa=a.auth_key||"",ga=a.secret_key||"",ha=a.hmac_SHA256,ia=a.ssl?"s":"",ja="http"+ia+"://"+(a.origin||"pubsub.pubnub.com"),ka=N(ja),la=N(ja),ma=function(){},na=[],oa=!0,pa=0,qa=0,ra=0,sa=0,ta=a.restore||0,ua=0,va=!1,wa={},xa={},ya={},za=null,Aa=x(a.heartbeat||a.pnexpires||0,a.error),Ba=a.heartbeat_interval||Aa/2-1,Ca=!1,Da=a.no_wait_for_pending,Ea=a["compatible_3.5"]||!1,Fa=a.xdr,Ga=a.params||{},Ha=a.error||function(){},Ia=a._is_online||function(){return 1},Ja=a.jsonp_cb||function(){return 0},Ka=a.db||{get:function(){},set:function(){}},La=a.cipher_key,Ma=a.uuid||!a.unique_uuid&&Ka&&Ka.get(ea+"uuid")||"",Na=a.instance_id||!1,Oa="",Pa=a.shutdown,Qa="undefined"!=typeof a.use_send_beacon?a.use_send_beacon:!0,Ra=Qa?a.sendBeacon:null;2===Aa&&(Ba=1);var Sa=a.crypto_obj||{encrypt:function(a,b){return a},decrypt:function(a,b){return a}},Ta={LEAVE:function(a,c,d,e,g){var h,i,j={uuid:Ma,auth:d||fa},k=N(ja),e=e||function(){},l=g||function(){},m=Ja();if(a.indexOf(B)>0)return!0;if(Ea){if(!ia)return!1;if("0"==m)return!1}return ca?!1:("0"!=m&&(j.callback=m),Na&&(j.instanceid=Oa),h=[k,"v2","presence","sub_key",ea,"channel",r(a),"leave"],i=b(j),Ra&&(url_string=f(h,i),Ra(url_string))?(e&&e({status:200,action:"leave",message:"OK",service:"Presence"}),!0):(Fa({blocking:c||ia,callback:m,data:i,success:function(a){Q(a,e,l)},fail:function(a){R(a,l)},url:h}),!0))},LEAVE_GROUP:function(a,c,d,e,g){var h,i,j={uuid:Ma,auth:d||fa},k=N(ja),e=e||function(){},l=g||function(){},m=Ja();if(a.indexOf(B)>0)return!0;if(Ea){if(!ia)return!1;if("0"==m)return!1}return ca?!1:("0"!=m&&(j.callback=m),a&&a.length>0&&(j["channel-group"]=a),Na&&(j.instanceid=Oa),h=[k,"v2","presence","sub_key",ea,"channel",r(","),"leave"],i=b(j),Ra&&(url_string=f(h,i),Ra(url_string))?(e&&e({status:200,action:"leave",message:"OK",service:"Presence"}),!0):(Fa({blocking:c||ia,callback:m,data:i,success:function(a){Q(a,e,l)},fail:function(a){R(a,l)},url:h}),!0))},set_resumed:function(a){va=a},get_cipher_key:function(){return La},set_cipher_key:function(a){La=a},raw_encrypt:function(a,b){return y(a,b)},raw_decrypt:function(a,b){return D(a,b)},get_heartbeat:function(){return Aa},set_heartbeat:function(a,b){Aa=x(a,Aa,Ha),Ba=b||Aa/2-1,2==Aa&&(Ba=1),ma(),H()},get_heartbeat_interval:function(){return Ba},set_heartbeat_interval:function(a){Ba=a,H()},get_version:function(){return L},getGcmMessageObject:function(a){return{data:a}},getApnsMessageObject:function(a){var b={aps:{badge:1,alert:""}};for(k in a)k[b]=a[k];return b},newPnMessage:function(){var a={};gcm&&(a.pn_gcm=gcm),apns&&(a.pn_apns=apns);for(k in n)a[k]=n[k];return a},_add_param:function(a,b){Ga[a]=b},channel_group:function(a,b){var c,d,e=a.channel_group,b=b||a.callback,f=a.channels||a.channel,g=a.cloak,h=[],i={},j=a.mode||"add";if(e){var k=e.split(":");k.length>1?(c="*"===k[0]?null:k[0],d=k[1]):d=k[0]}c&&h.push("namespace")&&h.push(r(c)),h.push("channel-group"),d&&"*"!==d&&h.push(d),f?(m(f)&&(f=f.join(",")),i[j]=f,i.cloak=oa?"true":"false"):"remove"===j&&h.push("remove"),"undefined"!=typeof g&&(i.cloak=g?"true":"false"),S(a,b,h,i)},channel_group_list_groups:function(a,b){var c;c=a.namespace||a.ns||a.channel_group||null,c&&(a.channel_group=c+":*"),Ta.channel_group(a,b)},channel_group_list_channels:function(a,b){return a.channel_group?void Ta.channel_group(a,b):Ha("Missing Channel Group")},channel_group_remove_channel:function(a,b){return a.channel_group?a.channel||a.channels?(a.mode="remove",void Ta.channel_group(a,b)):Ha("Missing Channel"):Ha("Missing Channel Group")},channel_group_remove_group:function(a,b){return a.channel_group?a.channel?Ha("Use channel_group_remove_channel if you want to remove a channel from a group."):(a.mode="remove",void Ta.channel_group(a,b)):Ha("Missing Channel Group")},channel_group_add_channel:function(a,b){return a.channel_group?a.channel||a.channels?void Ta.channel_group(a,b):Ha("Missing Channel"):Ha("Missing Channel Group")},channel_group_cloak:function(a,b){return"undefined"==typeof a.cloak?void b(oa):(oa=a.cloak,void Ta.channel_group(a,b))},channel_group_list_namespaces:function(a,b){var c=["namespace"];S(a,b,c)},channel_group_remove_namespace:function(a,b){var c=["namespace",a.namespace,"remove"];S(a,b,c)},history:function(a,c){var c=a.callback||c,d=a.count||a.limit||100,e=a.reverse||"false",f=a.error||function(){},g=a.auth_key||fa,h=a.cipher_key,i=a.channel,j=a.channel_group,k=a.start,l=a.end,m=a.include_token,n=a.string_message_token||!1,o={},p=Ja();return i||j?c?ea?(o.stringtoken="true",o.count=d,o.reverse=e,o.auth=g,j&&(o["channel-group"]=j,i||(i=",")),p&&(o.callback=p),k&&(o.start=k),l&&(o.end=l),m&&(o.include_token="true"),n&&(o.string_message_token="true"),void Fa({callback:p,data:b(o),success:function(a){if("object"==typeof a&&a.error)return void f({message:a.message,payload:a.payload});for(var b=a[0],d=[],e=0;e<b.length;e++)if(m){var g=D(b[e].message,h),i=b[e].timetoken;try{d.push({message:JSON.parse(g),timetoken:i})}catch(j){d.push({message:g,timetoken:i})}}else{var g=D(b[e],h);try{d.push(JSON.parse(g))}catch(j){d.push(g)}}c([d,a[1],a[2]])},fail:function(a){R(a,f)},url:[ka,"v2","history","sub-key",ea,"channel",r(i)]})):Ha("Missing Subscribe Key"):Ha("Missing Callback"):Ha("Missing Channel")},replay:function(a,c){var d,c=c||a.callback||function(){},e=a.auth_key||fa,f=a.source,g=a.destination,h=a.stop,i=a.start,j=a.end,k=a.reverse,l=a.limit,m=Ja(),n={};return f?g?da?ea?("0"!=m&&(n.callback=m),h&&(n.stop="all"),k&&(n.reverse="true"),i&&(n.start=i),j&&(n.end=j),l&&(n.count=l),n.auth=e,d=[ka,"v1","replay",da,ea,f,g],void Fa({callback:m,success:function(a){Q(a,c,err)},fail:function(){c([0,"Disconnected"])},url:d,data:b(n)})):Ha("Missing Subscribe Key"):Ha("Missing Publish Key"):Ha("Missing Destination Channel"):Ha("Missing Source Channel")},auth:function(a){fa=a,ma()},time:function(a){var c=Ja(),d={uuid:Ma,auth:fa};Na&&(d.instanceid=Oa),Fa({callback:c,data:b(d),url:[ka,"time",c],success:function(b){a(b[0])},fail:function(){a(0)}})},publish:function(a,c){var d=a.message;if(!d)return Ha("Missing Message");var e,f,c=c||a.callback||d.callback||a.success||function(){},g=a.channel||d.channel,h=a.auth_key||fa,i=a.cipher_key,j=a.error||d.error||function(){},k=a.post||!1,l="store_in_history"in a?a.store_in_history:!0,m=Ja(),n="push";return a.prepend&&(n="unshift"),g?da?ea?(d.getPubnubMessage&&(d=d.getPubnubMessage()),d=JSON.stringify(y(d,i)),f=[ka,"publish",da,ea,0,r(g),m,r(d)],e={uuid:Ma,auth:h},l||(e.store="0"),Na&&(e.instanceid=Oa),na[n]({callback:m,url:f,data:b(e),fail:function(a){R(a,j),M(1)},success:function(a){Q(a,c,j),M(1)},mode:k?"POST":"GET"}),void M()):Ha("Missing Subscribe Key"):Ha("Missing Publish Key"):Ha("Missing Channel")},unsubscribe:function(a,b){var c=a.channel,d=a.channel_group,e=a.auth_key||fa,b=b||a.callback||function(){},f=a.error||function(){};if(ua=0,ta=1,!c&&!d)return Ha("Missing Channel or Channel Group");if(!ea)return Ha("Missing Subscribe Key");if(c){var g=m(c)?c:(""+c).split(","),h=[],i=[];if(o(g,function(a){wa[a]&&h.push(a)}),0==h.length)return void b({action:"leave"});o(h,function(a){i.push(a+B)}),o(h.concat(i),function(a){a in wa&&(wa[a]=0),a in ya&&delete ya[a]});var j=!0;z&&(j=Ta.LEAVE(h.join(","),0,e,b,f)),j||b({action:"leave"})}if(d){var k=m(d)?d:(""+d).split(","),l=[],n=[];if(o(k,function(a){xa[a]&&l.push(a)}),0==l.length)return void b({action:"leave"});o(l,function(a){n.push(a+B)}),o(l.concat(n),function(a){a in xa&&(xa[a]=0),a in ya&&delete ya[a]});var j=!0;z&&(j=Ta.LEAVE_GROUP(l.join(","),0,e,b,f)),j||b({action:"leave"})}ma()},subscribe:function(a,c){function d(a){a?j(ma,y):(ka=N(ja,1),la=N(ja,1),j(function(){Ta.time(d)},G)),P(function(b){return a&&b.disconnected?(b.disconnected=0,b.reconnect(b.name)):void(a||b.disconnected||(b.disconnected=1,b.disconnect(b.name)))}),O(function(b){return a&&b.disconnected?(b.disconnected=0,b.reconnect(b.name)):void(a||b.disconnected||(b.disconnected=1,b.disconnect(b.name)))})}function f(){var a=Ja(),c=s(wa).join(","),e=t(xa).join(",");if(c||e){c||(c=","),V();var g=b({uuid:Ma,auth:fa});e&&(g["channel-group"]=e);var h=JSON.stringify(ya);h.length>2&&(g.state=JSON.stringify(ya)),Aa&&(g.heartbeat=Aa),Na&&(g.instanceid=Oa),I(),sa=Fa({timeout:x,callback:a,fail:function(a){a&&a.error&&a.service?(R(a,m),d(1)):Ta.time(function(b){!b&&R(a,m),d(b)})},data:b(g),url:[la,"subscribe",ea,r(c),a,ua],success:function(a){if(!a||"object"==typeof a&&"error"in a&&a.error)return m(a.error),j(ma,G);if(n(a[1]),ua=!ua&&ta&&Ka.get(ea)||a[1],P(function(a){a.connected||(a.connected=1,a.connect(a.name))}),O(function(a){a.connected||(a.connected=1,a.connect(a.name))}),va&&!ta)return ua=0,va=!1,Ka.set(ea,0),void j(f,y);v&&(ua=1e4,v=0),Ka.set(ea,a[1]);var b=function(){var b="",c="";a.length>3?(b=a[3],c=a[2]):b=a.length>2?a[2]:p(s(wa),function(b){return p(Array(a[0].length).join(",").split(","),function(){return b})}).join(",");var d=b.split(","),e=c?c.split(","):[];return function(){var a=d.shift()||ra,b=e.shift(),c={};b?(a&&a.indexOf("-pnpres")>=0&&b.indexOf("-pnpres")<0&&(b+="-pnpres"),c=xa[b]||wa[b]||{callback:function(){}}):c=wa[a];var f=[c.callback||qa,a.split(B)[0]];return b&&f.push(b.split(B)[0]),f}}(),c=W(+a[1]);o(a[0],function(d){var e=b(),f=D(d,wa[e[1]]?wa[e[1]].cipher_key:null);e[0]&&e[0](f,a,e[2]||e[1],c,e[1])}),j(f,y)}})}}var g=a.channel,h=a.channel_group,c=c||a.callback,c=c||a.message,i=a.connect||function(){},k=a.reconnect||function(){},l=a.disconnect||function(){},m=a.error||m||function(){},n=a.idle||function(){},q=a.presence||0,u=a.noheresync||0,v=a.backfill||0,w=a.timetoken||0,x=a.timeout||_,y=a.windowing||$,C=a.state,E=a.heartbeat||a.pnexpires,F=a.heartbeat_interval,H=a.restore||ta;return fa=a.auth_key||fa,ta=H,ua=w,g||h?c?ea?((E||0===E||F||0===F)&&Ta.set_heartbeat(E,F),g&&o((g.join?g.join(","):""+g).split(","),function(d){var f=wa[d]||{};wa[ra=d]={name:d,connected:f.connected,disconnected:f.disconnected,subscribed:1,callback:qa=c,cipher_key:a.cipher_key,connect:i,disconnect:l,reconnect:k},C&&(d in C?ya[d]=C[d]:ya[d]=C),q&&(Ta.subscribe({channel:d+B,callback:q,restore:H}),f.subscribed||u||Ta.here_now({channel:d,data:b({uuid:Ma,auth:fa}),callback:function(a){o("uuids"in a?a.uuids:[],function(b){q({action:"join",uuid:b,timestamp:Math.floor(e()/1e3),occupancy:a.occupancy||1},a,d)})}}))}),h&&o((h.join?h.join(","):""+h).split(","),function(d){var f=xa[d]||{};xa[d]={name:d,connected:f.connected,disconnected:f.disconnected,subscribed:1,callback:qa=c,cipher_key:a.cipher_key,connect:i,disconnect:l,reconnect:k},q&&(Ta.subscribe({channel_group:d+B,callback:q,restore:H,auth_key:fa}),f.subscribed||u||Ta.here_now({channel_group:d,data:b({uuid:Ma,auth:fa}),callback:function(a){o("uuids"in a?a.uuids:[],function(b){q({action:"join",uuid:b,timestamp:Math.floor(e()/1e3),occupancy:a.occupancy||1},a,d)})}}))}),ma=function(){V(),j(f,y)},z?void ma():A.push(ma)):Ha("Missing Subscribe Key"):Ha("Missing Callback"):Ha("Missing Channel")},here_now:function(a,c){var c=a.callback||c,d=a.debug,e=a.error||function(){},f=a.auth_key||fa,g=a.channel,h=a.channel_group,i=Ja(),j="uuids"in a?a.uuids:!0,k=a.state,l={uuid:Ma,auth:f};if(j||(l.disable_uuids=1),k&&(l.state=1),!c)return Ha("Missing Callback");if(!ea)return Ha("Missing Subscribe Key");var m=[ka,"v2","presence","sub_key",ea];g&&m.push("channel")&&m.push(r(g)),"0"!=i&&(l.callback=i),h&&(l["channel-group"]=h,!g&&m.push("channel")&&m.push(",")),Na&&(l.instanceid=Oa),Fa({callback:i,data:b(l),success:function(a){Q(a,c,e)},fail:function(a){R(a,e)},debug:d,url:m})},where_now:function(a,c){var c=a.callback||c,d=a.error||function(){},e=a.auth_key||fa,f=Ja(),g=a.uuid||Ma,h={auth:e};return c?ea?("0"!=f&&(h.callback=f),Na&&(h.instanceid=Oa),void Fa({callback:f,data:b(h),success:function(a){Q(a,c,d)},fail:function(a){R(a,d)},url:[ka,"v2","presence","sub_key",ea,"uuid",r(g)]})):Ha("Missing Subscribe Key"):Ha("Missing Callback")},state:function(a,c){var d,c=a.callback||c||function(a){},e=a.error||function(){},f=a.auth_key||fa,g=Ja(),h=a.state,i=a.uuid||Ma,j=a.channel,k=a.channel_group,l=b({auth:f});return ea?i?j||k?("0"!=g&&(l.callback=g),"undefined"!=typeof j&&wa[j]&&wa[j].subscribed&&h&&(ya[j]=h),"undefined"!=typeof k&&xa[k]&&xa[k].subscribed&&(h&&(ya[k]=h),l["channel-group"]=k,j||(j=",")),l.state=JSON.stringify(h),Na&&(l.instanceid=Oa),d=h?[ka,"v2","presence","sub-key",ea,"channel",j,"uuid",i,"data"]:[ka,"v2","presence","sub-key",ea,"channel",j,"uuid",r(i)],void Fa({callback:g,data:b(l),success:function(a){Q(a,c,e)},fail:function(a){R(a,e)},url:d})):Ha("Missing Channel"):Ha("Missing UUID"):Ha("Missing Subscribe Key")},grant:function(a,c){var c=a.callback||c,d=a.error||function(){},e=a.channel||a.channels,f=a.channel_group,g=Ja(),h=a.ttl,i=a.read?"1":"0",j=a.write?"1":"0",k=a.manage?"1":"0",l=a.auth_key||a.auth_keys;if(!c)return Ha("Missing Callback");if(!ea)return Ha("Missing Subscribe Key");if(!da)return Ha("Missing Publish Key");if(!ga)return Ha("Missing Secret Key");var n=Math.floor((new Date).getTime()/1e3),o=ea+"\n"+da+"\ngrant\n",p={w:j,r:i,timestamp:n};a.manage&&(p.m=k),m(e)&&(e=e.join(",")),m(l)&&(l=l.join(",")),"undefined"!=typeof e&&null!=e&&e.length>0&&(p.channel=e),"undefined"!=typeof f&&null!=f&&f.length>0&&(p["channel-group"]=f),"0"!=g&&(p.callback=g),(h||0===h)&&(p.ttl=h),l&&(p.auth=l),p=b(p),l||delete p.auth,o+=w(p);var q=ha(o,ga);q=q.replace(/\+/g,"-"),q=q.replace(/\//g,"_"),p.signature=q,Fa({callback:g,data:p,success:function(a){Q(a,c,d)},fail:function(a){R(a,d)},url:[ka,"v1","auth","grant","sub-key",ea]})},mobile_gw_provision:function(a){var b,c,d=a.callback||function(){},e=a.auth_key||fa,f=a.error||function(){},g=Ja(),h=a.channel,i=a.op,j=a.gw_type,k=a.device_id;return k?j?i?h?da?ea?(c=[ka,"v1/push/sub-key",ea,"devices",k],b={uuid:Ma,auth:e,type:j},"add"==i?b.add=h:"remove"==i&&(b.remove=h),Na&&(data.instanceid=Oa),void Fa({callback:g,data:b,success:function(a){Q(a,d,f)},fail:function(a){R(a,f)},url:c})):Ha("Missing Subscribe Key"):Ha("Missing Publish Key"):Ha("Missing gw destination Channel (channel)"):Ha("Missing GW Operation (op: add or remove)"):Ha("Missing GW Type (gw_type: gcm or apns)"):Ha("Missing Device ID (device_id)")},audit:function(a,c){var c=a.callback||c,d=a.error||function(){},e=a.channel,f=a.channel_group,g=a.auth_key,h=Ja();if(!c)return Ha("Missing Callback");if(!ea)return Ha("Missing Subscribe Key");if(!da)return Ha("Missing Publish Key");if(!ga)return Ha("Missing Secret Key");var i=Math.floor((new Date).getTime()/1e3),j=ea+"\n"+da+"\naudit\n",k={timestamp:i};"0"!=h&&(k.callback=h),"undefined"!=typeof e&&null!=e&&e.length>0&&(k.channel=e),"undefined"!=typeof f&&null!=f&&f.length>0&&(k["channel-group"]=f),g&&(k.auth=g),k=b(k),g||delete k.auth,j+=w(k);var l=ha(j,ga);l=l.replace(/\+/g,"-"),l=l.replace(/\//g,"_"),k.signature=l,Fa({callback:h,data:k,success:function(a){Q(a,c,d)},fail:function(a){R(a,d)},url:[ka,"v1","auth","audit","sub-key",ea]})},revoke:function(a,b){a.read=!1,a.write=!1,Ta.grant(a,b)},set_uuid:function(a){Ma=a,ma()},get_uuid:function(){return Ma},isArray:function(a){return m(a)},get_subscribed_channels:function(){return s(wa,!0)},presence_heartbeat:function(a){var c=a.callback||function(){},d=a.error||function(){},e=Ja(),f={uuid:Ma,auth:fa},g=JSON.stringify(ya);g.length>2&&(f.state=JSON.stringify(ya)),Aa>0&&320>Aa&&(f.heartbeat=Aa),"0"!=e&&(f.callback=e);var h=r(s(wa,!0).join(",")),i=t(xa,!0).join(",");h||(h=","),i&&(f["channel-group"]=i),Na&&(f.instanceid=Oa),Fa({callback:e,data:b(f),url:[ka,"v2","presence","sub-key",ea,"channel",h,"heartbeat"],success:function(a){Q(a,c,d)},fail:function(a){R(a,d)}})},stop_timers:function(){clearTimeout(Y),clearTimeout(Z),clearTimeout(za)},shutdown:function(){Ta.stop_timers(),Pa&&Pa()},xdr:Fa,ready:u,db:Ka,uuid:l,map:p,each:o,"each-channel":P,grep:h,offline:function(){V(1,{message:"Offline. Please check your network settings."})},supplant:i,now:e,unique:d,updater:g};return Ma||(Ma=Ta.uuid()),Oa||(Oa=Ta.uuid()),Ka.set(ea+"uuid",Ma),Y=j(T,G),Z=j(U,aa),za=j(I,(Ba-3)*G),X(),Ta}var x=c(3),y=1,z=!1,A=[],B="-pnpres",C=10,D=15e3,E=310,F=60,G=1e3,H="/",I="&",J=5,K=30,L=x.version,M=/{([\w\-]+)}/g,N=function(){var a=20,b=Math.floor(Math.random()*a);return function(c,d){return c.indexOf("pubsub.")>0&&c.replace("pubsub","ps"+(d?l().split("-")[0]:++b<a?b:b=1))||c}}();a.exports={PN_API:w,unique:d,PNmessage:v,DEF_TIMEOUT:D,timeout:j,build_url:f,each:o,uuid:l,URLBIT:H}}])});