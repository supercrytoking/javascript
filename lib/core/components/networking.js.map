{"version":3,"sources":["core/components/networking.js"],"names":[],"mappings":";;;;;;;;AAEA;;;;AAEA;;;;AACA;;;;AACA;;;;AAEA;;;;;;;AA0BE,wBAA+D;AAAA,QAAjD,MAAiD,QAAjD,MAAiD;AAAA,QAAzC,MAAyC,QAAzC,MAAyC;AAAA,QAAjC,UAAiC,QAAjC,UAAiC;;AAAA;;AAC7D,SAAK,OAAL,GAAe,MAAf;AACA,SAAK,OAAL,GAAe,MAAf;AACA,SAAK,WAAL,GAAmB,UAAnB;;AAEA,SAAK,aAAL,GAAqB,EAArB;AACA,SAAK,iBAAL,GAAyB,KAAK,KAAL,CAAW,KAAK,MAAL,KAAgB,KAAK,aAAhC,CAAzB;;AAEA,SAAK,aAAL,GAAqB,CAAC,KAAK,OAAL,CAAa,MAAb,GAAsB,UAAtB,GAAmC,SAApC,IAAiD,KAAK,OAAL,CAAa,MAAnF;AACA,SAAK,WAAL,GAAmB,EAAnB;;AAGA,SAAK,mBAAL,CAAyB,KAAzB;AACD;;;;+BAEU,Q,EAA2B;AAEpC,UAAI,KAAK,aAAL,CAAmB,OAAnB,CAA2B,SAA3B,MAA0C,CAAC,CAA/C,EAAkD;AAChD,eAAO,KAAK,aAAZ;AACD;;AAED,UAAI,qBAAJ;;AAEA,UAAI,QAAJ,EAAc;AACZ,uBAAe,gBAAM,YAAN,GAAqB,KAArB,CAA2B,GAA3B,EAAgC,CAAhC,CAAf;AACD,OAFD,MAEO;AACL,aAAK,iBAAL,GAAyB,KAAK,iBAAL,GAAyB,CAAlD;;AAEA,YAAI,KAAK,iBAAL,IAA0B,KAAK,aAAnC,EAAkD;AAAE,eAAK,iBAAL,GAAyB,CAAzB;AAA6B;;AAEjF,uBAAe,KAAK,iBAAL,CAAuB,QAAvB,EAAf;AACD;;AAED,aAAO,KAAK,aAAL,CAAmB,OAAnB,CAA2B,QAA3B,EAAqC,OAAO,YAA5C,CAAP;AACD;;;0CAGsD;AAAA,UAAnC,QAAmC,yDAAf,KAAe;;AACrD,WAAK,eAAL,GAAuB,KAAK,UAAL,CAAgB,QAAhB,CAAvB;;AAEA,aAAO,KAAK,eAAZ;AACD;;;wCAE2B;AAC1B,aAAO,KAAK,eAAZ;AACD;;;yBAEI,M,EAAiB,I,EAAc,Q,EAA8B,Q,EAAgC;AAChG,UAAI,sBAAsB,qBACvB,IADuB,CAClB,KAAK,iBAAL,KAA2B,SAAS,GADlB,EAEvB,KAFuB,CAEjB,MAFiB,EAGvB,IAHuB,CAGlB,IAHkB,CAA1B;AAIA,aAAO,KAAK,cAAL,CAAoB,mBAApB,EAAyC,SAAS,OAAlD,EAA2D,QAA3D,CAAP;AACD;;;wBAEG,M,EAAiB,Q,EAA8B,Q,EAAgC;AACjF,UAAI,sBAAsB,qBACvB,GADuB,CACnB,KAAK,iBAAL,KAA2B,SAAS,GADjB,EAEvB,KAFuB,CAEjB,MAFiB,CAA1B;AAGA,aAAO,KAAK,cAAL,CAAoB,mBAApB,EAAyC,SAAS,OAAlD,EAA2D,QAA3D,CAAP;AACD;;;mCAEc,mB,EAAiC,O,EAA+B,Q,EAAgC;AAE7G,UAAI,KAAK,OAAL,CAAa,YAAjB,EAA+B;AAC7B,8BAAsB,oBAAoB,GAApB,CAAwB,KAAK,OAAL,EAAxB,CAAtB;AACD;;AAED,aAAO,oBACJ,IADI,CACC,MADD,EAEJ,OAFI,CAEI,WAAW,KAAK,OAAL,CAAa,qBAAb,EAFf,EAGJ,GAHI,CAGA,UAAC,GAAD,EAAM,IAAN,EAAe;AAClB,YAAI,SAAuB,EAA3B;AACA,eAAO,KAAP,GAAe,GAAf;;AAIA,YAAI,GAAJ,EAAS;AACP,iBAAO,SAAS,MAAT,EAAiB,IAAjB,CAAP;AACD;;AAED,YAAI,iBAAiB,KAAK,KAAL,CAAW,KAAK,IAAhB,CAArB;AACA,eAAO,SAAS,MAAT,EAAiB,cAAjB,CAAP;AACD,OAfI,CAAP;AAgBD;;;4BAEO,O,EAAS;AACf,UAAI,CAAC,OAAL,EAAc,UAAU,EAAV;AACd,UAAI,mBAAmB,qBAAW,OAAlC,EAA2C;AACzC,eAAO,KAAK,uBAAL,CAA6B,EAA7B,EAAiC,OAAjC,CAAP;AACD,OAFD,MAEO;AACL,eAAO,KAAK,uBAAL,CAA6B,IAA7B,CAAkC,IAAlC,EAAwC,OAAxC,CAAP;AACD;AACF;;;4CAEuB,O,EAAS,G,EAAK;AACpC,UAAI,QAAQ,IAAI,IAAJ,GAAW,OAAX,EAAZ;AACA,UAAI,YAAY,IAAI,IAAJ,GAAW,WAAX,EAAhB;AACA,cAAQ,GAAR,CAAY,OAAZ;AACA,cAAQ,GAAR,CAAY,MAAM,SAAN,GAAkB,GAA9B,EAAmC,IAAnC,EAAyC,IAAI,GAA7C,EAAkD,IAAlD,EAAwD,IAAI,EAA5D;AACA,cAAQ,GAAR,CAAY,OAAZ;;AAEA,UAAI,EAAJ,CAAO,UAAP,EAAmB,UAAC,GAAD,EAAS;AAC1B,YAAI,MAAM,IAAI,IAAJ,GAAW,OAAX,EAAV;AACA,YAAI,UAAU,MAAM,KAApB;AACA,YAAI,gBAAgB,IAAI,IAAJ,GAAW,WAAX,EAApB;;AAEA,gBAAQ,GAAR,CAAY,QAAZ;AACA,gBAAQ,GAAR,CAAY,MAAM,aAAN,GAAsB,KAAtB,GAA8B,OAA9B,GAAwC,GAApD,EAAyD,IAAzD,EAA+D,IAAI,GAAnE,EAAwE,IAAxE,EAA8E,IAAI,EAAlF,EAAsF,IAAtF,EAA4F,IAAI,IAAhG;AACA,gBAAQ,GAAR,CAAY,OAAZ;AACD,OARD;AASD","file":"core/components/networking.js","sourcesContent":["/* @flow */\n\nimport superagent from 'superagent';\n\nimport Crypto from './cryptography/index';\nimport Config from './config.js';\nimport utils from '../utils';\n\nimport { endpointDefinition, statusStruct } from '../flow_interfaces';\n\ntype networkingModules = {\n  crypto: Crypto,\n  config: Config,\n  sendBeacon: Function\n}\n\nexport default class {\n  _sendBeacon: Function;\n\n  _config: Config;\n  _crypto: Crypto;\n\n  _maxSubDomain: number;\n  _currentSubDomain: number;\n\n  _standardOrigin: string;\n  _subscribeOrigin: string;\n\n  _providedFQDN: string;\n\n  _requestTimeout: number;\n\n  _coreParams: Object; /* items that must be passed with each request. */\n\n  constructor({ config, crypto, sendBeacon }: networkingModules) {\n    this._config = config;\n    this._crypto = crypto;\n    this._sendBeacon = sendBeacon;\n\n    this._maxSubDomain = 20;\n    this._currentSubDomain = Math.floor(Math.random() * this._maxSubDomain);\n\n    this._providedFQDN = (this._config.secure ? 'https://' : 'http://') + this._config.origin;\n    this._coreParams = {};\n\n    // create initial origins\n    this.shiftStandardOrigin(false);\n  }\n\n  nextOrigin(failover: boolean): string {\n    // if a custom origin is supplied, use do not bother with shuffling subdomains\n    if (this._providedFQDN.indexOf('pubsub.') === -1) {\n      return this._providedFQDN;\n    }\n\n    let newSubDomain: string;\n\n    if (failover) {\n      newSubDomain = utils.generateUUID().split('-')[0];\n    } else {\n      this._currentSubDomain = this._currentSubDomain + 1;\n\n      if (this._currentSubDomain >= this._maxSubDomain) { this._currentSubDomain = 1; }\n\n      newSubDomain = this._currentSubDomain.toString();\n    }\n\n    return this._providedFQDN.replace('pubsub', 'ps' + newSubDomain);\n  }\n\n  // origin operations\n  shiftStandardOrigin(failover: boolean = false): string {\n    this._standardOrigin = this.nextOrigin(failover);\n\n    return this._standardOrigin;\n  }\n\n  getStandardOrigin(): string {\n    return this._standardOrigin;\n  }\n\n  POST(params : Object, body: string, endpoint: endpointDefinition, callback: Function): superagent {\n    let superagentConstruct = superagent\n      .post(this.getStandardOrigin() + endpoint.url)\n      .query(params)\n      .send(body);\n    return this._abstractedXDR(superagentConstruct, endpoint.timeout, callback);\n  }\n\n  GET(params : Object, endpoint: endpointDefinition, callback: Function): superagent {\n    let superagentConstruct = superagent\n      .get(this.getStandardOrigin() + endpoint.url)\n      .query(params);\n    return this._abstractedXDR(superagentConstruct, endpoint.timeout, callback);\n  }\n\n  _abstractedXDR(superagentConstruct: superagent, timeout: number | null | void, callback: Function): superagent {\n    // attach a logger\n    if (this._config.logVerbosity) {\n      superagentConstruct = superagentConstruct.use(this._logger());\n    }\n\n    return superagentConstruct\n      .type('json')\n      .timeout(timeout || this._config.getTransactionTimeout())\n      .end((err, resp) => {\n        let status: statusStruct = {};\n        status.error = err;\n\n        // console.log(err);\n\n        if (err) {\n          return callback(status, null);\n        }\n\n        let parsedResponse = JSON.parse(resp.text);\n        return callback(status, parsedResponse);\n      });\n  }\n\n  _logger(options) {\n    if (!options) options = {};\n    if (options instanceof superagent.Request) {\n      return this._attachSuperagentLogger({}, options);\n    } else {\n      return this._attachSuperagentLogger.bind(null, options);\n    }\n  }\n\n  _attachSuperagentLogger(options, req) {\n    let start = new Date().getTime();\n    let timestamp = new Date().toISOString();\n    console.log('<<<<<');                                               // eslint-disable-line no-console\n    console.log('[' + timestamp + ']', '\\n', req.url, '\\n', req.qs);    // eslint-disable-line no-console\n    console.log('-----');                                               // eslint-disable-line no-console\n\n    req.on('response', (res) => {\n      let now = new Date().getTime();\n      let elapsed = now - start;\n      let timestampDone = new Date().toISOString();\n\n      console.log('>>>>>>');                                                                                  // eslint-disable-line no-console\n      console.log('[' + timestampDone + ' / ' + elapsed + ']', '\\n', req.url, '\\n', req.qs, '\\n', res.text);  // eslint-disable-line no-console\n      console.log('-----');                                                                                   // eslint-disable-line no-console\n    });\n  }\n}\n"],"sourceRoot":"/source/"}