{"version":3,"sources":["networking/index.js"],"names":["modules","_modules","Object","keys","forEach","key","bind","config","_config","_maxSubDomain","_currentSubDomain","Math","floor","random","_coreParams","shiftStandardOrigin","canonicalOrigin","origin","split","thirdLevelDomain","restDomains","protocol","secure","separator","hasCustomOrigin","shard","join","name","_standardOrigin","nextOrigin","url","fields","file","postfile","params","endpoint","callback","getfile","body","post","patch","get","del","err","code","categoryConstants","PNNetworkIssuesCategory","status","hasOwnProperty","timeout","PNTimeoutCategory","response","badRequest","PNBadRequestCategory","forbidden","PNAccessDeniedCategory","PNUnknownCategory"],"mappings":"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","sourcesContent":["/* @flow */\n\nimport Config from '../core/components/config';\nimport categoryConstants from '../core/constants/categories';\n\nimport { EndpointDefinition, NetworkingModules } from '../core/flow_interfaces';\n\nexport default class {\n  _modules: NetworkingModules;\n  _config: Config;\n\n  _maxSubDomain: number;\n  _currentSubDomain: number;\n\n  _standardOrigin: string;\n  _subscribeOrigin: string;\n\n  _requestTimeout: number;\n\n  _coreParams: Object; /* items that must be passed with each request. */\n\n  constructor(modules: NetworkingModules) {\n    this._modules = {};\n\n    Object.keys(modules).forEach((key) => {\n      this._modules[key] = modules[key].bind(this);\n    });\n  }\n\n  init(config: Config) {\n    this._config = config;\n\n    this._maxSubDomain = 10;\n    this._currentSubDomain = Math.floor(Math.random() * this._maxSubDomain);\n    this._coreParams = {};\n\n    // create initial origins\n    this.shiftStandardOrigin();\n  }\n\n  nextOrigin(): string {\n    this._currentSubDomain += 1;\n\n    if (this._currentSubDomain >= this._maxSubDomain) {\n      this._currentSubDomain = 0;\n    }\n\n    const canonicalOrigin = this._config.origin;\n    const [thirdLevelDomain, ...restDomains] = canonicalOrigin.split('.');\n\n    const protocol = this._config.secure ? 'https://' : 'http://';\n    const separator = this._config.hasCustomOrigin() ? '-' : '';\n    const shard = this._config.hasCustomOrigin() ? this._currentSubDomain : this._currentSubDomain + 1;\n\n    return `${protocol}${thirdLevelDomain}${separator}${shard}.${restDomains.join('.')}`;\n  }\n\n  hasModule(name: string) {\n    return name in this._modules;\n  }\n\n  // origin operations\n  shiftStandardOrigin(): string {\n    this._standardOrigin = this.nextOrigin();\n\n    return this._standardOrigin;\n  }\n\n  getStandardOrigin(): string {\n    return this._standardOrigin;\n  }\n\n  POSTFILE(url: string, fields: $ReadOnlyArray<{ key: string, value: string }>, file: any) {\n    return this._modules.postfile(url, fields, file);\n  }\n\n  GETFILE(params: Object, endpoint: EndpointDefinition, callback: Function) {\n    return this._modules.getfile(params, endpoint, callback);\n  }\n\n  POST(params: Object, body: string, endpoint: EndpointDefinition, callback: Function) {\n    return this._modules.post(params, body, endpoint, callback);\n  }\n\n  PATCH(params: Object, body: string, endpoint: EndpointDefinition, callback: Function) {\n    return this._modules.patch(params, body, endpoint, callback);\n  }\n\n  GET(params: Object, endpoint: EndpointDefinition, callback: Function) {\n    return this._modules.get(params, endpoint, callback);\n  }\n\n  DELETE(params: Object, endpoint: EndpointDefinition, callback: Function) {\n    return this._modules.del(params, endpoint, callback);\n  }\n\n  _detectErrorCategory(err: Object): string {\n    if (err.code === 'ENOTFOUND') {\n      return categoryConstants.PNNetworkIssuesCategory;\n    }\n    if (err.code === 'ECONNREFUSED') {\n      return categoryConstants.PNNetworkIssuesCategory;\n    }\n    if (err.code === 'ECONNRESET') {\n      return categoryConstants.PNNetworkIssuesCategory;\n    }\n    if (err.code === 'EAI_AGAIN') {\n      return categoryConstants.PNNetworkIssuesCategory;\n    }\n\n    if (err.status === 0 || (err.hasOwnProperty('status') && typeof err.status === 'undefined')) {\n      return categoryConstants.PNNetworkIssuesCategory;\n    }\n    if (err.timeout) return categoryConstants.PNTimeoutCategory;\n\n    if (err.code === 'ETIMEDOUT') {\n      return categoryConstants.PNNetworkIssuesCategory;\n    }\n\n    if (err.response) {\n      if (err.response.badRequest) {\n        return categoryConstants.PNBadRequestCategory;\n      }\n      if (err.response.forbidden) {\n        return categoryConstants.PNAccessDeniedCategory;\n      }\n    }\n\n    return categoryConstants.PNUnknownCategory;\n  }\n}\n"],"file":"index.js"}