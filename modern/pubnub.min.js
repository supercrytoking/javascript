// 3.4.3
(function(){
function l(){return function(){}}var aa=1,m=!1,n=[],s="-pnpres",t=1E3,ba=/{([\w\-]+)}/g;function ca(){return"x"+ ++aa+""+ +new Date}function z(){return+new Date}var D,E=Math.floor(20*Math.random());D=function(a,b){return 0<a.indexOf("pubsub.")&&a.replace("pubsub","ps"+(b?G().split("-")[0]:20>++E?E:E=1))||a};function da(a,b){function d(){e+b>z()?(clearTimeout(c),c=setTimeout(d,b)):(e=z(),a())}var c,e=0;return d}function ea(a,b){var d=[];J(a||[],function(a){b(a)&&d.push(a)});return d}
function fa(a,b){return a.replace(ba,function(a,c){return b[c]||a})}function G(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)});a&&a(b);return b}function J(a,b){if(a&&b)if("undefined"!=typeof a[0])for(var d=0,c=a.length;d<c;)b.call(a[d],a[d],d++);else for(d in a)a.hasOwnProperty&&a.hasOwnProperty(d)&&b.call(a[d],d,a[d])}function K(a,b){var d=[];J(a||[],function(a,e){d.push(b(a,e))});return d}
function L(a){return K(encodeURIComponent(a).split(""),function(a){return 0>"-_.!~*'()".indexOf(a)?a:"%"+a.charCodeAt(0).toString(16).toUpperCase()}).join("")}function M(a){var b=[];J(a,function(a,c){c.f&&b.push(a)});return b.sort()}function ga(){setTimeout(function(){m||(m=1,J(n,function(a){a()}))},t)}
function Q(a){function b(a){e||(e=1,clearTimeout(B),c&&(c.onerror=c.onload=null,c.abort&&c.abort(),c=null),a&&u())}function d(){if(!F){F=1;clearTimeout(B);try{response=JSON.parse(c.responseText)}catch(a){return b(1)}p(response)}}var c,e=0,F=0,B;B=setTimeout(function(){b(1)},R);var u=a.b||l(),p=a.c||l();try{c="undefined"!==typeof XDomainRequest&&new XDomainRequest||new XMLHttpRequest;c.onerror=c.onabort=function(){b(1)};c.onload=c.onloadend=d;c.timeout=R;url=a.url.join(ha);if(a.data){var g=[];url+=
"?";for(key in a.data)g.push(key+"="+a.data[key]);url+=g.join(ia)}c.open("GET",url,!0);c.send()}catch(v){return b(0),Q(a)}return b}function S(a,b,d){J(a.split(","),function(a){function e(a){a||(a=window.event);d(a)||(a.cancelBubble=!0,a.returnValue=!1,a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation())}b.addEventListener?b.addEventListener(a,e,!1):b.attachEvent?b.attachEvent("on"+a,e):b["on"+a]=e})}
function T(a){function b(){}function d(a){J(M(i),function(b){(b=i[b])&&a(b)})}function c(a){a&&(j.g=0);!j.g&&j.length&&(j.g=1,q(j.shift()))}a.db=U;a.xdr=Q;var e,F=+a.windowing||10,B=(+a.timeout||310)*t,u=(+a.keepalive||60)*t,p=a.publish_key||"",g=a.subscribe_key||"",v=a.ssl?"s":"",A="http"+v+"://"+(a.origin||"pubsub.pubnub.com"),w=D(A),W=D(A),j=[],X=0,Y=0,N=0,O=0,Z=0,C=0,i={},q=a.xdr,P=a._is_online||function(){return 1},r=a.jsonp_cb||function(){return 0},x=a.db||{get:l(),set:l()},y=a.uuid||x&&x.get(g+
"uuid")||"",f={_reset_offline:function(){N&&N(1)},LEAVE:function(a,b){var c={uuid:y},d=D(A),e=r();0<a.indexOf(s)||("0"!=e&&(c.callback=e),q({l:b||v,timeout:2E3,a:e,data:c,url:[d,"v2","presence","sub_key",g,"channel",L(a),"leave"]}))},history:function(a,b){var b=a.callback||b,c=a.count||a.limit||100,d=a.reverse||"false",e=a.error||l(),f=a.channel,I=a.start,i=a.end,h={},k=r();if(!f)return error("Missing Channel");if(!b)return error("Missing Callback");if(!g)return error("Missing Subscribe Key");h.stringtoken=
"true";h.count=c;h.reverse=d;k&&(h.callback=k);I&&(h.start=I);i&&(h.end=i);q({a:k,data:h,c:function(a){b(a)},b:e,url:[w,"v2","history","sub-key",g,"channel",L(f)]})},replay:function(a){var b=b||a.callback||l(),c=a.source,d=a.destination,e=a.stop,f=a.start,i=a.end,j=a.reverse,a=a.limit,h=r(),k={};if(!c)return error("Missing Source Channel");if(!d)return error("Missing Destination Channel");if(!p)return error("Missing Publish Key");if(!g)return error("Missing Subscribe Key");"0"!=h&&(k.callback=h);
e&&(k.stop="all");j&&(k.reverse="true");f&&(k.start=f);i&&(k.end=i);a&&(k.count=a);q({a:h,c:function(a){b(a)},b:function(){b([0,"Disconnected"])},url:[w,"v1","replay",p,g,c,d],data:k})},time:function(a){var b=r();q({a:b,timeout:5*t,url:[w,"time",b],c:function(b){a(b[0])},b:function(){a(0)}})},publish:function(a,b){var b=b||a.callback||l(),d=a.message,e=a.channel,f=r();if(!d)return error("Missing Message");if(!e)return error("Missing Channel");if(!p)return error("Missing Publish Key");if(!g)return error("Missing Subscribe Key");
d=JSON.stringify(d);e=[w,"publish",p,g,0,L(e),f,L(d)];j.push({a:f,timeout:5*t,url:e,data:{uuid:y},c:function(a){b(a);c(1)},b:function(){b([0,"Failed",d]);c(1)}});c()},unsubscribe:function(a){a=a.channel;C=0;O=1;a=K((a.join?a.join(","):""+a).split(","),function(a){return a+","+a+s}).join(",");J(a.split(","),function(a){m&&f.LEAVE(a,0);i[a]=0});m&&b()},subscribe:function(a,c){function e(a){a?setTimeout(j,t):(w=D(A,1),W=D(A,1),setTimeout(function(){f.time(e)},t));d(function(b){if(a&&b.d)return b.d=0,
b.j(b.name);!a&&!b.d&&(b.d=1,b.i(b.name))})}function j(){var a=r(),b=M(i).join(",");b&&(N=q({timeout:P,a:a,b:function(){f.time(e)},data:{uuid:y},url:[W,"subscribe",g,L(b),a,C],c:function(a){if(!a)return setTimeout(j,$);d(function(a){a.e||(a.e=1,a.h(a.name))});C=!C&&O&&x.get(g)||a[1];v&&(Timetoken=1E4,v=0);x.set(g,a[1]);var b,c=(2<a.length?a[2]:"").split(",");b=function(){var a=c.shift()||"";return[(i[a]||{}).a||X,(a||Y).split(s)[0]]};J(a[0],function(c){var d=b();if(i[d[1]].f)d[0](c,a,d[1])});setTimeout(j,
$)}}))}var H=a.channel,c=(c=c||a.callback)||a.message,p=a.connect||l(),I=a.reconnect||l(),u=a.disconnect||l(),h=a.presence||0,k=a.noheresync||0,v=a.backfill||0,P=a.timeout||B,$=a.windowing||F;a.restore&&(O=1);C=0;if(!H)return error("Missing Channel");if(!c)return error("Missing Callback");if(!g)return error("Missing Subscribe Key");J((H.join?H.join(","):""+H).split(","),function(a){var b=i[a]||{};i[Y=a]={name:a,e:b.e,d:b.d,f:1,a:X=c,h:p,i:u,j:I};h&&(f.subscribe({channel:a+s,callback:h}),!b.f&&!k&&
f.here_now({channel:a,callback:function(b){J("uuids"in b?b.uuids:[],function(c){h({action:"join",uuid:c,timestamp:z(),occupancy:b.occupancy||1},b,a)})}}))});b=function(){f._reset_offline();clearTimeout(Z);Z=setTimeout(j,100)};if(!m)return n.push(b);b()},here_now:function(a,b){var b=a.callback||b,c=a.error||l(),d=a.channel,e=r(),f=null;if(!d)return error("Missing Channel");if(!b)return error("Missing Callback");if(!g)return error("Missing Subscribe Key");"0"!=e&&(f={},f.callback=e);q({a:e,data:f,c:function(a){b(a)},
b:c,url:[w,"v2","presence","sub_key",g,"channel",L(d)]})},xdr:q,ready:ga,db:x,uuid:G,each:J,map:K,grep:ea,supplant:fa,now:z,unique:ca,updater:da,poll_online:function(){P()||f._reset_offline();setTimeout(f.poll_online,t)},poll_online2:function(){f.time(function(a){a||f._reset_offline();setTimeout(f.poll_online2,u)})}};y||(y=f.uuid());x.set(g+"uuid",y);setTimeout(f.poll_online,t);setTimeout(f.poll_online2,u);e=f;e.init=T;if(a.notest)return e;S("beforeunload",window,function(){each_channel(function(a){e.LEAVE(a.name,
1)});return!0});S("offline",window,e._reset_offline);S("offline",document,e._reset_offline);e.ready();return e}var ha="/",ia="&",R=31E4,U,V="undefined"!=typeof localStorage&&localStorage;U={get:function(a){try{return V?V.getItem(a):-1==document.cookie.indexOf(a)?null:((document.cookie||"").match(RegExp(a+"=([^;]+)"))||[])[1]||null}catch(b){}},set:function(a,b){try{if(V)return V.setItem(a,b)&&0;document.cookie=a+"="+b+"; expires=Thu, 1 Aug 2030 20:00:00 UTC; path=/"}catch(d){}}};
"undefined"!==typeof module&&(module.m=T)||"undefined"!==typeof exports&&(exports.k=T)||(PUBNUB=T);
})();
