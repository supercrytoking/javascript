{"version":3,"sources":["core/endpoints/file_upload/send_file.js"],"names":["sendFile","generateUploadUrl","publishFile","modules","PubNubFile","config","cryptography","networking","channel","input","file","message","cipherKey","meta","ttl","storeInHistory","PubNubError","create","name","file_upload_request","url","formFields","form_fields","data","id","encryptFile","formFieldsWithMimeType","mimeType","map","entry","key","value","supportsFile","toFile","FILE","result","supportsBuffer","toBuffer","supportsBlob","toBlob","Error","status","retries","wasSuccessful","fileId","fileName","deps","f","params","cb","resultP","then","error"],"mappings":"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","sourcesContent":["/** @flow */\n\nimport { PubNubError, createValidationError } from '../../components/endpoint';\nimport type {\n  SendFileParams,\n  SendFileResult,\n  GenerateUploadUrlParams,\n  GenerateUploadUrlResult,\n  PublishFileParams,\n  PublishFileResult,\n} from './types';\n\nimport type { Modules } from '../endpoint';\n\ntype Dependencies = {|\n  generateUploadUrl: (params: GenerateUploadUrlParams) => Promise<GenerateUploadUrlResult>,\n  publishFile: (params: PublishFileParams) => Promise<PublishFileResult>,\n  modules: Modules,\n|};\n\nconst sendFile = ({\n  generateUploadUrl,\n  publishFile,\n  modules: { PubNubFile, config, cryptography, networking },\n}: Dependencies) => async ({\n  channel,\n  file: input,\n  message,\n  cipherKey,\n  meta,\n  ttl,\n  storeInHistory,\n}: SendFileParams): Promise<SendFileResult> => {\n  if (!channel) {\n    throw new PubNubError(\n      'Validation failed, check status for details',\n      createValidationError(\"channel can't be empty\")\n    );\n  }\n\n  if (!input) {\n    throw new PubNubError('Validation failed, check status for details', createValidationError(\"file can't be empty\"));\n  }\n\n  let file = PubNubFile.create(input);\n\n  const {\n    file_upload_request: { url, form_fields: formFields },\n    data: { id, name },\n  } = await generateUploadUrl({ channel, name: file.name });\n\n  if (cipherKey ?? config.cipherKey) {\n    file = await cryptography.encryptFile(cipherKey ?? config.cipherKey, file, PubNubFile);\n  }\n\n  let formFieldsWithMimeType = formFields;\n\n  if (file.mimeType) {\n    formFieldsWithMimeType = formFields.map((entry) => {\n      if (entry.key === 'Content-Type') return { key: entry.key, value: file.mimeType };\n      else return entry;\n    });\n  }\n\n  let result;\n\n  try {\n    if (PubNubFile.supportsFile) {\n      result = await networking.FILE(url, formFieldsWithMimeType, await file.toFile());\n    } else if (PubNubFile.supportsBuffer) {\n      result = await networking.FILE(url, formFieldsWithMimeType, await file.toBuffer());\n    } else if (PubNubFile.supportsBlob) {\n      result = await networking.FILE(url, formFieldsWithMimeType, await file.toBlob());\n    } else {\n      throw new Error('Unsupported environment');\n    }\n  } catch (e) {\n    throw new PubNubError('Upload to bucket failed', e);\n  }\n\n  if (result.status !== 204) {\n    throw new PubNubError('Upload to bucket was unsuccessful', result);\n  }\n\n  let retries = 5;\n  let wasSuccessful = false;\n\n  while (!wasSuccessful && retries > 0) {\n    try {\n      await publishFile({\n        channel,\n        message,\n        fileId: id,\n        fileName: name,\n        meta,\n        storeInHistory,\n        ttl,\n      });\n\n      wasSuccessful = true;\n    } catch (e) {\n      retries -= 1;\n    }\n  }\n  if (!wasSuccessful) {\n    throw new PubNubError('Publish failed. You may want to execute that operation manually using pubnub.publishFile', {\n      channel,\n      id,\n      name,\n    });\n  } else {\n    return {\n      id,\n      name,\n    };\n  }\n};\n\nexport default (deps: Dependencies) => {\n  const f = sendFile(deps);\n\n  return (params: SendFileParams, cb?: (error: any, params: SendFileResult) => void): Promise<SendFileResult> => {\n    const resultP = f(params);\n\n    if (typeof cb === 'function') {\n      resultP.then((result) => cb(null, result)).catch((error) => cb(error, (null: any)));\n\n      return resultP;\n    } else {\n      return resultP;\n    }\n  };\n};\n"],"file":"send_file.js"}