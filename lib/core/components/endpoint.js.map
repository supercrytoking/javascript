{"version":3,"sources":["core/components/endpoint.js"],"names":["modules","endpoint","networking","config","crypto","callback","incomingParams","getOperation","PNTimeOperation","PNChannelGroupsOperation","validationResult","validateParams","createValidationError","outgoingParams","prepareParams","uuid","UUID","pnsdk","generatePNSDK","useInstanceId","instanceid","instanceId","useRequestId","requestid","v4","isAuthSupported","getAuthKey","auth","secretKey","timestamp","Math","floor","Date","getTime","signInput","subscribeKey","publishKey","PNAccessManagerGrant","PNAccessManagerAudit","decideURL","signPamFromParams","signature","HMACSHA256","onResponse","status","payload","error","handleResponse","callInstance","url","networkingParams","operation","timeout","getRequestTimeout","usePost","postPayload","POST","GET","PNSubscribeOperation","createError","errorPayload","type","message","postURL","getURL","base","sdkFamily","partnerId","getVersion"],"mappings":"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","file":"core/components/endpoint.js","sourcesContent":["import uuidGenerator from 'uuid';\n\nimport { StatusAnnouncement } from '../flow_interfaces';\nimport utils from '../utils';\nimport Config from './config';\nimport operationConstants from '../constants/operations';\n\nfunction createError(errorPayload: Object, type: string): Object {\n  errorPayload.type = type;\n  return errorPayload;\n}\n\nfunction createValidationError(message: string): Object {\n  return createError({ message }, 'validationError');\n}\n\nfunction decideURL(endpoint, modules, incomingParams) {\n  if (endpoint.usePost && endpoint.usePost(modules, incomingParams)) {\n    return endpoint.postURL(modules, incomingParams);\n  } else {\n    return endpoint.getURL(modules, incomingParams);\n  }\n}\n\nfunction generatePNSDK(config: Config): string {\n  let base = 'PubNub-JS-' + config.sdkFamily;\n\n  if (config.partnerId) {\n    base += '-' + config.partnerId;\n  }\n\n  base += '/' + config.getVersion();\n\n  return base;\n}\n\nexport default function (modules, endpoint, ...args) {\n  let { networking, config, crypto } = modules;\n  let callback = null;\n  let incomingParams = {};\n\n  if (endpoint.getOperation() === operationConstants.PNTimeOperation || endpoint.getOperation() === operationConstants.PNChannelGroupsOperation) {\n    callback = args[0];\n  } else {\n    incomingParams = args[0];\n    callback = args[1];\n  }\n\n  let validationResult = endpoint.validateParams(modules, incomingParams);\n\n  if (validationResult) {\n    callback(createValidationError(validationResult));\n    return;\n  }\n\n  let outgoingParams = endpoint.prepareParams(modules, incomingParams);\n\n  outgoingParams.uuid = config.UUID;\n  outgoingParams.pnsdk = generatePNSDK(config);\n\n  if (config.useInstanceId) {\n    outgoingParams.instanceid = config.instanceId;\n  }\n\n  if (config.useRequestId) {\n    outgoingParams.requestid = uuidGenerator.v4();\n  }\n\n  if (endpoint.isAuthSupported() && config.getAuthKey()) {\n    outgoingParams.auth = config.getAuthKey();\n  }\n\n  if (config.secretKey) {\n    outgoingParams.timestamp = Math.floor(new Date().getTime() / 1000);\n    let signInput = config.subscribeKey + '\\n' + config.publishKey + '\\n';\n\n    if (endpoint.getOperation() === operationConstants.PNAccessManagerGrant) {\n      signInput += 'grant\\n';\n    } else if (endpoint.getOperation() === operationConstants.PNAccessManagerAudit) {\n      signInput += 'audit\\n';\n    } else {\n      signInput += decideURL(endpoint, modules, incomingParams) + '\\n';\n    }\n\n    signInput += utils.signPamFromParams(outgoingParams);\n    outgoingParams.signature = crypto.HMACSHA256(signInput);\n  }\n\n  let onResponse = (status: StatusAnnouncement, payload: Object) => {\n    if (callback) {\n      if (status.error) return callback(status);\n\n      callback(status, endpoint.handleResponse(modules, payload, incomingParams));\n    }\n  };\n\n  let callInstance;\n  let url = decideURL(endpoint, modules, incomingParams);\n  let networkingParams = { url,\n    operation: endpoint.getOperation(),\n    timeout: endpoint.getRequestTimeout(modules)\n  };\n\n  if (endpoint.usePost && endpoint.usePost(modules, incomingParams)) {\n    let payload = endpoint.postPayload(modules, incomingParams);\n    callInstance = networking.POST(outgoingParams, payload, networkingParams, onResponse);\n  } else {\n    callInstance = networking.GET(outgoingParams, networkingParams, onResponse);\n  }\n\n  if (endpoint.getOperation() === operationConstants.PNSubscribeOperation) {\n    return callInstance;\n  }\n}\n"],"sourceRoot":"/source/"}