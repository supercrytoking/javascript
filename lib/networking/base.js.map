{"version":3,"sources":["networking/base.js"],"names":["modules","agentKeepAliveModule","sendBeaconModule","_agentKeepAlive","_sendBeacon","config","_config","_maxSubDomain","_currentSubDomain","Math","floor","random","_providedFQDN","secure","origin","_coreParams","shiftStandardOrigin","indexOf","newSubDomain","toString","replace","failover","_standardOrigin","nextOrigin","params","body","endpoint","callback","superagentConstruct","post","getStandardOrigin","url","query","send","_abstractedXDR","get","logVerbosity","use","_attachSuperagentLogger","proxy","keepAlive","timeout","end","err","resp","status","error","operation","statusCode","errorData","category","_detectErrorCategory","parsedResponse","JSON","parse","text","code","PNNetworkIssuesCategory","hasOwnProperty","PNTimeoutCategory","response","badRequest","PNBadRequestCategory","forbidden","PNAccessDeniedCategory","PNUnknownCategory","req","_pickLogger","console","log","window","start","Date","getTime","timestamp","toISOString","logger","qs","on","res","now","elapsed","timestampDone"],"mappings":";;;;;;;;AAGA;;;;AACA;;;;AACA;;;;AAEA;;;;;;;AAoBE,kBAAYA,OAAZ,EAAwC;AAAA;;AAAA,QAChCC,oBADgC,GACWD,OADX,CAChCC,oBADgC;AAAA,QACVC,gBADU,GACWF,OADX,CACVE,gBADU;;;AAGtC,SAAKC,eAAL,GAAuBF,oBAAvB;AACA,SAAKG,WAAL,GAAmBF,gBAAnB;AACD;;;;yBAEIG,M,EAAgB;AACnB,WAAKC,OAAL,GAAeD,MAAf;;AAEA,WAAKE,aAAL,GAAqB,EAArB;AACA,WAAKC,iBAAL,GAAyBC,KAAKC,KAAL,CAAWD,KAAKE,MAAL,KAAgB,KAAKJ,aAAhC,CAAzB;AACA,WAAKK,aAAL,GAAqB,CAAC,KAAKN,OAAL,CAAaO,MAAb,GAAsB,UAAtB,GAAmC,SAApC,IAAiD,KAAKP,OAAL,CAAaQ,MAAnF;AACA,WAAKC,WAAL,GAAmB,EAAnB;;AAGA,WAAKC,mBAAL;AACD;;;iCAEoB;AAEnB,UAAI,KAAKJ,aAAL,CAAmBK,OAAnB,CAA2B,SAA3B,MAA0C,CAAC,CAA/C,EAAkD;AAChD,eAAO,KAAKL,aAAZ;AACD;;AAED,UAAIM,qBAAJ;;AAEA,WAAKV,iBAAL,GAAyB,KAAKA,iBAAL,GAAyB,CAAlD;;AAEA,UAAI,KAAKA,iBAAL,IAA0B,KAAKD,aAAnC,EAAkD;AAChD,aAAKC,iBAAL,GAAyB,CAAzB;AACD;;AAEDU,qBAAe,KAAKV,iBAAL,CAAuBW,QAAvB,EAAf;;AAEA,aAAO,KAAKP,aAAL,CAAmBQ,OAAnB,CAA2B,QAA3B,SAA0CF,YAA1C,CAAP;AACD;;;0CAGsD;AAAA,UAAnCG,QAAmC,uEAAf,KAAe;;AACrD,WAAKC,eAAL,GAAuB,KAAKC,UAAL,CAAgBF,QAAhB,CAAvB;;AAEA,aAAO,KAAKC,eAAZ;AACD;;;wCAE2B;AAC1B,aAAO,KAAKA,eAAZ;AACD;;;yBAEIE,M,EAAiBC,I,EAAcC,Q,EAA8BC,Q,EAAgC;AAChG,UAAIC,sBAAsB,qBACvBC,IADuB,CAClB,KAAKC,iBAAL,KAA2BJ,SAASK,GADlB,EAEvBC,KAFuB,CAEjBR,MAFiB,EAGvBS,IAHuB,CAGlBR,IAHkB,CAA1B;AAIA,aAAO,KAAKS,cAAL,CAAoBN,mBAApB,EAAyCF,QAAzC,EAAmDC,QAAnD,CAAP;AACD;;;wBAEGH,M,EAAiBE,Q,EAA8BC,Q,EAAgC;AACjF,UAAIC,sBAAsB,qBACvBO,GADuB,CACnB,KAAKL,iBAAL,KAA2BJ,SAASK,GADjB,EAEvBC,KAFuB,CAEjBR,MAFiB,CAA1B;AAGA,aAAO,KAAKU,cAAL,CAAoBN,mBAApB,EAAyCF,QAAzC,EAAmDC,QAAnD,CAAP;AACD;;;mCAEcC,mB,EAAiCF,Q,EAA8BC,Q,EAA4B;AAAA;;AAExG,UAAI,KAAKrB,OAAL,CAAa8B,YAAjB,EAA+B;AAC7BR,8BAAsBA,oBAAoBS,GAApB,CAAwB,KAAKC,uBAA7B,CAAtB;AACD;;AAED,UAAI,KAAKhC,OAAL,CAAaiC,KAAjB,EAAwB;AACtBX,8BAAsBA,oBAAoBW,KAApB,CAA0B,KAAKjC,OAAL,CAAaiC,KAAvC,CAAtB;AACD;;AAED,UAAI,KAAKjC,OAAL,CAAakC,SAAb,IAA0B,KAAKrC,eAAnC,EAAoD;AAClDyB,8BAAsB,KAAKzB,eAAL,CAAqByB,mBAArB,CAAtB;AACD;;AAED,aAAOA,oBACJa,OADI,CACIf,SAASe,OADb,EAEJC,GAFI,CAEA,UAACC,GAAD,EAAMC,IAAN,EAAe;AAClB,YAAIC,SAA6B,EAAjC;AACAA,eAAOC,KAAP,GAAeH,QAAQ,IAAvB;AACAE,eAAOE,SAAP,GAAmBrB,SAASqB,SAA5B;;AAEA,YAAIH,QAAQA,KAAKC,MAAjB,EAAyB;AACvBA,iBAAOG,UAAP,GAAoBJ,KAAKC,MAAzB;AACD;;AAED,YAAIF,GAAJ,EAAS;AACPE,iBAAOI,SAAP,GAAmBN,GAAnB;AACAE,iBAAOK,QAAP,GAAkB,MAAKC,oBAAL,CAA0BR,GAA1B,CAAlB;AACA,iBAAOhB,SAASkB,MAAT,EAAiB,IAAjB,CAAP;AACD;;AAED,YAAIO,iBAAiBC,KAAKC,KAAL,CAAWV,KAAKW,IAAhB,CAArB;AACA,eAAO5B,SAASkB,MAAT,EAAiBO,cAAjB,CAAP;AACD,OAnBI,CAAP;AAoBD;;;yCAEoBT,G,EAAqB;AACxC,UAAIA,IAAIa,IAAJ,KAAa,WAAjB,EAA8B,OAAO,qBAAkBC,uBAAzB;AAC9B,UAAId,IAAIa,IAAJ,KAAa,cAAjB,EAAiC,OAAO,qBAAkBC,uBAAzB;AACjC,UAAId,IAAIa,IAAJ,KAAa,YAAjB,EAA+B,OAAO,qBAAkBC,uBAAzB;AAC/B,UAAId,IAAIa,IAAJ,KAAa,WAAjB,EAA8B,OAAO,qBAAkBC,uBAAzB;;AAE9B,UAAId,IAAIE,MAAJ,KAAe,CAAf,IAAqBF,IAAIe,cAAJ,CAAmB,QAAnB,KAAgC,OAAOf,IAAIE,MAAX,KAAsB,WAA/E,EAA6F,OAAO,qBAAkBY,uBAAzB;AAC7F,UAAId,IAAIF,OAAR,EAAiB,OAAO,qBAAkBkB,iBAAzB;;AAEjB,UAAIhB,IAAIiB,QAAR,EAAkB;AAChB,YAAIjB,IAAIiB,QAAJ,CAAaC,UAAjB,EAA6B,OAAO,qBAAkBC,oBAAzB;AAC7B,YAAInB,IAAIiB,QAAJ,CAAaG,SAAjB,EAA4B,OAAO,qBAAkBC,sBAAzB;AAC7B;;AAED,aAAO,qBAAkBC,iBAAzB;AACD;;;4CAEuBC,G,EAAa;AACnC,UAAIC,cAAc,SAAdA,WAAc,GAAM;AACtB,YAAIC,WAAWA,QAAQC,GAAvB,EAA4B,OAAOD,OAAP;AAC5B,YAAIE,UAAUA,OAAOF,OAAjB,IAA4BE,OAAOF,OAAP,CAAeC,GAA/C,EAAoD,OAAOC,OAAOF,OAAd;AACpD,eAAOA,OAAP;AACD,OAJD;;AAMA,UAAIG,QAAQ,IAAIC,IAAJ,GAAWC,OAAX,EAAZ;AACA,UAAIC,YAAY,IAAIF,IAAJ,GAAWG,WAAX,EAAhB;AACA,UAAIC,SAAST,aAAb;AACAS,aAAOP,GAAP,CAAW,OAAX;AACAO,aAAOP,GAAP,OAAeK,SAAf,QAA6B,IAA7B,EAAmCR,IAAInC,GAAvC,EAA4C,IAA5C,EAAkDmC,IAAIW,EAAtD;AACAD,aAAOP,GAAP,CAAW,OAAX;;AAEAH,UAAIY,EAAJ,CAAO,UAAP,EAAmB,UAACC,GAAD,EAAS;AAC1B,YAAIC,MAAM,IAAIR,IAAJ,GAAWC,OAAX,EAAV;AACA,YAAIQ,UAAUD,MAAMT,KAApB;AACA,YAAIW,gBAAgB,IAAIV,IAAJ,GAAWG,WAAX,EAApB;;AAEAC,eAAOP,GAAP,CAAW,QAAX;AACAO,eAAOP,GAAP,OAAea,aAAf,WAAkCD,OAAlC,QAA8C,IAA9C,EAAoDf,IAAInC,GAAxD,EAA6D,IAA7D,EAAmEmC,IAAIW,EAAvE,EAA2E,IAA3E,EAAiFE,IAAIxB,IAArF;AACAqB,eAAOP,GAAP,CAAW,OAAX;AACD,OARD;AASD","file":"base.js","sourcesContent":["/* @flow */\n/* global window */\n\nimport superagent from 'superagent';\nimport Config from '../core/components/config';\nimport categoryConstants from '../core/constants/categories';\n\nimport { EndpointDefinition, StatusAnnouncement, NetworkingModules } from '../core/flow_interfaces';\n\nexport default class {\n  _sendBeacon: Function;\n  _agentKeepAlive: Function;\n\n  _config: Config;\n\n  _maxSubDomain: number;\n  _currentSubDomain: number;\n\n  _standardOrigin: string;\n  _subscribeOrigin: string;\n\n  _providedFQDN: string;\n\n  _requestTimeout: number;\n\n  _coreParams: Object; /* items that must be passed with each request. */\n\n  constructor(modules: NetworkingModules) {\n    let { agentKeepAliveModule, sendBeaconModule } = modules;\n\n    this._agentKeepAlive = agentKeepAliveModule;\n    this._sendBeacon = sendBeaconModule;\n  }\n\n  init(config: Config) {\n    this._config = config;\n\n    this._maxSubDomain = 20;\n    this._currentSubDomain = Math.floor(Math.random() * this._maxSubDomain);\n    this._providedFQDN = (this._config.secure ? 'https://' : 'http://') + this._config.origin;\n    this._coreParams = {};\n\n    // create initial origins\n    this.shiftStandardOrigin();\n  }\n\n  nextOrigin(): string {\n    // if a custom origin is supplied, use do not bother with shuffling subdomains\n    if (this._providedFQDN.indexOf('pubsub.') === -1) {\n      return this._providedFQDN;\n    }\n\n    let newSubDomain: string;\n\n    this._currentSubDomain = this._currentSubDomain + 1;\n\n    if (this._currentSubDomain >= this._maxSubDomain) {\n      this._currentSubDomain = 1;\n    }\n\n    newSubDomain = this._currentSubDomain.toString();\n\n    return this._providedFQDN.replace('pubsub', `ps${newSubDomain}`);\n  }\n\n  // origin operations\n  shiftStandardOrigin(failover: boolean = false): string {\n    this._standardOrigin = this.nextOrigin(failover);\n\n    return this._standardOrigin;\n  }\n\n  getStandardOrigin(): string {\n    return this._standardOrigin;\n  }\n\n  POST(params : Object, body: string, endpoint: EndpointDefinition, callback: Function): superagent {\n    let superagentConstruct = superagent\n      .post(this.getStandardOrigin() + endpoint.url)\n      .query(params)\n      .send(body);\n    return this._abstractedXDR(superagentConstruct, endpoint, callback);\n  }\n\n  GET(params : Object, endpoint: EndpointDefinition, callback: Function): superagent {\n    let superagentConstruct = superagent\n      .get(this.getStandardOrigin() + endpoint.url)\n      .query(params);\n    return this._abstractedXDR(superagentConstruct, endpoint, callback);\n  }\n\n  _abstractedXDR(superagentConstruct: superagent, endpoint: EndpointDefinition, callback: Function): Object {\n    // attach a logger\n    if (this._config.logVerbosity) {\n      superagentConstruct = superagentConstruct.use(this._attachSuperagentLogger);\n    }\n\n    if (this._config.proxy) {\n      superagentConstruct = superagentConstruct.proxy(this._config.proxy);\n    }\n\n    if (this._config.keepAlive && this._agentKeepAlive) {\n      superagentConstruct = this._agentKeepAlive(superagentConstruct);\n    }\n\n    return superagentConstruct\n      .timeout(endpoint.timeout)\n      .end((err, resp) => {\n        let status: StatusAnnouncement = {};\n        status.error = err !== null;\n        status.operation = endpoint.operation;\n\n        if (resp && resp.status) {\n          status.statusCode = resp.status;\n        }\n\n        if (err) {\n          status.errorData = err;\n          status.category = this._detectErrorCategory(err);\n          return callback(status, null);\n        }\n\n        let parsedResponse = JSON.parse(resp.text);\n        return callback(status, parsedResponse);\n      });\n  }\n\n  _detectErrorCategory(err: Object): string {\n    if (err.code === 'ENOTFOUND') return categoryConstants.PNNetworkIssuesCategory;\n    if (err.code === 'ECONNREFUSED') return categoryConstants.PNNetworkIssuesCategory;\n    if (err.code === 'ECONNRESET') return categoryConstants.PNNetworkIssuesCategory;\n    if (err.code === 'EAI_AGAIN') return categoryConstants.PNNetworkIssuesCategory;\n\n    if (err.status === 0 || (err.hasOwnProperty('status') && typeof err.status === 'undefined')) return categoryConstants.PNNetworkIssuesCategory;\n    if (err.timeout) return categoryConstants.PNTimeoutCategory;\n\n    if (err.response) {\n      if (err.response.badRequest) return categoryConstants.PNBadRequestCategory;\n      if (err.response.forbidden) return categoryConstants.PNAccessDeniedCategory;\n    }\n\n    return categoryConstants.PNUnknownCategory;\n  }\n\n  _attachSuperagentLogger(req: Object) {\n    let _pickLogger = () => {\n      if (console && console.log) return console; // eslint-disable-line no-console\n      if (window && window.console && window.console.log) return window.console;\n      return console;\n    };\n\n    let start = new Date().getTime();\n    let timestamp = new Date().toISOString();\n    let logger = _pickLogger();\n    logger.log('<<<<<');                                               // eslint-disable-line no-console\n    logger.log(`[${timestamp}]`, '\\n', req.url, '\\n', req.qs);    // eslint-disable-line no-console\n    logger.log('-----');                                               // eslint-disable-line no-console\n\n    req.on('response', (res) => {\n      let now = new Date().getTime();\n      let elapsed = now - start;\n      let timestampDone = new Date().toISOString();\n\n      logger.log('>>>>>>');                                                                                  // eslint-disable-line no-console\n      logger.log(`[${timestampDone} / ${elapsed}]`, '\\n', req.url, '\\n', req.qs, '\\n', res.text);  // eslint-disable-line no-console\n      logger.log('-----');                                                                                   // eslint-disable-line no-console\n    });\n  }\n}\n"]}