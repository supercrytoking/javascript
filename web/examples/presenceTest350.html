<html>
<script>

var channelA = "gecA";
var channelB = "gecB";
var randomSuffix = "";

var ssl = false;
var clientLevel = "";
var serverLevel = "";

var pubKey = "";
var subKey = "";

var listenerUUID = "PN_LISTENER";
var actorUUID = "PN_ACTOR";

var pnLoadedInterval = "";
var listener = "";
var actor = "";
var extraCompat = "";


var keysets = {

    "keyset1": {
        "pubKey": "pub-c-fb5fa283-0d93-424f-bf86-d9aca2366c86",
        "subKey": "sub-c-d247d250-9dbd-11e3-8008-02ee2ddab7fe",
        "secKey": "sec-c-MmI2YjRjODAtNWU5My00ZmZjLTg0MzUtZGM1NGExNjJkNjg1",
        "description": "Compatibility Mode ON"
    },

    "keyset2": {
        "pubKey": "pub-c-c9b0fe21-4ae1-433b-b766-62667cee65ef",
        "subKey": "sub-c-d91ee366-9dbd-11e3-a759-02ee2ddab7fe",
        "secKey": "sec-c-ZDUxZGEyNmItZjY4Ny00MjJmLWE0MjQtZTQyMDM0NTY2MDVk",
        "description": "Compatibility Mode OFF"
    }
};

var tests = {

    "35_35_SSL_OFF": {

        "common": {
            "description": "3.5 -> 3.5 Base Compatibility, SSL Off.",
            "client": "3.5",
            "server": "3.5",
            "keyset": keysets.keyset1,
            "ssl": false,
            "maxSteps": 3
        },

        "testSpecific": {

        },

        "platformSpecific": {
            "JS_WEB": {
                "clientExtraCompatibilityFlag": true // actually doesn't matter for 3.5 -> 3.5
            }
        },

        "steps": {
            1: {
                "actor": ["subscribe", channelA, 0],
                "listener": ["join", channelA, 5]
            },

            2: {
                "actor": ["subscribe", channelB, 5],

                "listener": [
                    ["leave", channelA, 5],
                    ["join", channelA, 5],
                    ["join", channelB, 5]
                ]
            },

            3: {
                "actor": ["unsubscribe", channelA, 5],
                "listener": [
                    ["leave", channelA, 5],
                    ["leave", channelB, 5],
                    ["join", channelB, 5]
                ]
            }
        }
    }
};


runTest(tests["35_35_SSL_OFF"]);

function runTest(testNub) {
    console.log("Running test: " + testNub.description);
    ssl = testNub.common.ssl;
    clientLevel = testNub.common.client;
    serverLevel = testNub.common.server;
    pubKey = testNub.common.keyset.pubKey;
    subKey = testNub.common.keyset.subKey;
    extraCompat = testNub.platformSpecific.JS_WEB.clientExtraCompatibilityFlag;
}

var pnLoading = true;
loadPNLib();

function loadPNLib() {
    if (typeof PUBNUB === 'undefined') {

        console.log("PN is not loaded. Trying to load.");


        if (clientLevel == "3.6") {
            if (ssl) {
                url = "https://s3.amazonaws.com/pubnub/pubnub-3.6.0-beta.js";
            }
            else {
                url = "http://s3.amazonaws.com/pubnub/pubnub-3.6.0-beta.js";
            }
        }
        else if (clientLevel == "3.5") {
            if (ssl) {
                url = "https://s3.amazonaws.com/pubnub/pubnub-3.5.48.min.js";
            }
            else {
                url = "http://s3.amazonaws.com/pubnub/pubnub-3.5.48.min.js";
            }
        }
        else {
            console.log("ERROR! Could not determine proper JS to load.");
        }


        var fileref = document.createElement('script');
        fileref.setAttribute("type", "text/javascript");
        fileref.setAttribute("src", url);

        if (typeof fileref != "undefined")
            document.getElementsByTagName("head")[0].appendChild(fileref)

        fileref.onload = function (e) {
            console.log("Pn is now Loaded!");
            pnLoading = false;
        }

        pnLoadedInterval = setInterval(waitForPNLoad, 1000);

    } else {
        console.log("PN is already loaded.");
        pnLoading = false;
        waitForPNLoad();
    }
}


function waitForPNLoad() {
    if (pnLoading) {
        console.log("Waiting for PN to finish loading.");
        pnLoadedInterval = setInterval(waitForPNLoad, 1000);
    } else {
        console.log("Initializing listener and actor instances.");
        clearInterval(pnLoadedInterval);

        randomSuffix = Math.floor((Math.random() * 10000) + 1);

        actorUUID = actorUUID + randomSuffix;
        listenerUUID = listenerUUID + randomSuffix;

        listener = pnInit(ssl, subKey, true);
        actor = pnInit(ssl, subKey, false);

        // Start the Listener. The actor will be spawned after the listener is connected.
        subToA(listener, actor);


    }
}

function pnInit(ssl, key, isListener) {

    var uuid = isListener ? listenerUUID : actorUUID;
    var origin = (clientLevel == "3.6") ? "presence-beta.pubnub.com" : "pubsub.pubnub.com";

    var pubnub = PUBNUB.init({
        publish_key: 'demo',
        subscribe_key: key,
        origin: origin,
        ssl: ssl,
        "compatible_3.5": extraCompat,
        uuid: uuid
    });

    console.log(uuid + ": " + key + "\nOrigin: " + origin + "\nClient level: " + clientLevel + "\nServer level: " + serverLevel + "\nCompat: " + true + "\nClient extra compat flag: " + extraCompat + "\nSSL: " + ssl);
    return pubnub;
}


function subToA(listener, pn) {
    listener.subscribe({
        noheresync: true,
        channel: "gecA",
        message: function (m) {
            console.log("Listener heard: " + m);
        },
        presence: function (msg, e, ch) {
            if (msg.uuid != listenerUUID && msg.uuid == actorUUID) {
                console.log("Presence Listener: " + msg.action + " on " + msg.uuid + ": " + ch);
            }


        },
        connect: function () {
            // actor.set_uuid("foo");

            pn.subscribe({
                noheresync: true,
                channel: "gecA",
                message: function (m) {
                    console.log("PN msg received: " + m);
                },
                connect: function () {
                    console.log("PN Connected");
                }
            });


        }
    });
}

function subToB() {
    pubnub.subscribe({
        channel: "gecB",
        message: function (m) {
            console.log(m);
        },
        connect: connected
    });
}


function unsubToa() {
    actor.unsubscribe({
        channel: "gecA"
    });


    listener.unsubscribe({
        channel: "gecA"
    });

}

function unsubTob() {
    pubnub.unsubscribe({
        channel: "gecB"
    });
}

function connected() {
    console.log("connected.");
}

</script>


</html>
