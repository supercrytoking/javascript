{"version":3,"sources":["core/endpoints/history.js"],"names":["getOperation","validateParams","getURL","getRequestTimeout","isAuthSupported","prepareParams","handleResponse","__processMessage","modules","message","config","crypto","cipherKey","decrypt","e","PNHistoryOperation","incomingParams","channel","subscribeKey","encodeURIComponent","getTransactionTimeout","start","end","includeTimetoken","reverse","count","stringifiedTimeToken","outgoingParams","string_message_token","include_token","toString","serverResponse","response","messages","startTimeToken","endTimeToken","forEach","serverHistoryItem","item","timetoken","entry","push"],"mappings":"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","file":"history.js","sourcesContent":["/* @flow */\n\nimport { FetchHistoryArguments, HistoryResponse, HistoryItem, ModulesInject } from '../flow_interfaces';\nimport operationConstants from '../constants/operations';\n\nfunction __processMessage(modules, message: Object): Object | null {\n  let { config, crypto } = modules;\n  if (!config.cipherKey) return message;\n\n  try {\n    return crypto.decrypt(message);\n  } catch (e) {\n    return message;\n  }\n}\n\nexport function getOperation(): string {\n  return operationConstants.PNHistoryOperation;\n}\n\nexport function validateParams(modules: ModulesInject, incomingParams: FetchHistoryArguments) {\n  let { channel } = incomingParams;\n  let { config } = modules;\n\n  if (!channel) return 'Missing channel';\n  if (!config.subscribeKey) return 'Missing Subscribe Key';\n}\n\nexport function getURL(modules: ModulesInject, incomingParams: FetchHistoryArguments): string {\n  let { channel } = incomingParams;\n  let { config } = modules;\n  return '/v2/history/sub-key/' + config.subscribeKey + '/channel/' + encodeURIComponent(channel);\n}\n\nexport function getRequestTimeout({ config }: ModulesInject): boolean {\n  return config.getTransactionTimeout();\n}\n\nexport function isAuthSupported(): boolean {\n  return true;\n}\n\nexport function prepareParams(modules: ModulesInject, incomingParams: FetchHistoryArguments): Object {\n  const { start, end, includeTimetoken, reverse, count = 100, stringifiedTimeToken = false } = incomingParams;\n  let outgoingParams = {};\n\n  outgoingParams.count = count;\n  if (start) outgoingParams.start = start;\n  if (end) outgoingParams.end = end;\n  if (stringifiedTimeToken) outgoingParams.string_message_token = stringifiedTimeToken;\n  if (includeTimetoken != null) outgoingParams.include_token = includeTimetoken.toString();\n  if (reverse != null) outgoingParams.reverse = reverse.toString();\n\n  return outgoingParams;\n}\n\nexport function handleResponse(modules: ModulesInject, serverResponse: FetchHistoryArguments): HistoryResponse {\n  const response: HistoryResponse = {\n    messages: [],\n    startTimeToken: serverResponse[1],\n    endTimeToken: serverResponse[2],\n  };\n\n  serverResponse[0].forEach((serverHistoryItem) => {\n    const item: HistoryItem = {\n      timetoken: null,\n      entry: null\n    };\n\n    if (serverHistoryItem.timetoken) {\n      item.timetoken = serverHistoryItem.timetoken;\n      item.entry = __processMessage(modules, serverHistoryItem.message);\n    } else {\n      item.entry = __processMessage(modules, serverHistoryItem);\n    }\n\n    response.messages.push(item);\n  });\n\n  return response;\n}\n"]}